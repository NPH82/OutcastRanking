<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manager Comparison - OutcastRanking</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="{{ url_for('static', filename='dark-mode.js') }}"></script>
    <style>
        .comparison-header {
            background: var(--bg-primary);
            color: var(--text-white);
            padding: 30px 0;
            margin-bottom: 30px;
        }
        
        .comparison-stats {
            background: var(--bg-secondary);
            border-left: 4px solid var(--primary-color);
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 0 10px 10px 0;
        }
        
        .missing-managers {
            background: var(--warning-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            color: var(--text-primary);
        }
        
        .results-section {
            margin-bottom: 30px;
        }
        
        .results-header h2 {
            color: var(--text-primary);
            margin-bottom: 10px;
        }
        
        .table-container {
            background: var(--bg-card);
            border-radius: 10px;
            box-shadow: 0 4px 8px var(--shadow);
            overflow: hidden;
        }
        
        .results-table {
            margin-bottom: 0;
        }
        
        .results-table th {
            background: #2c5aa0;
            color: white;
            font-weight: 600;
            border: none;
            padding: 15px 10px;
        }
        
        .results-table td {
            padding: 12px 10px;
            vertical-align: middle;
            border-bottom: 1px solid #e9ecef;
        }
        
        .results-table tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        .rank {
            font-size: 18px;
            font-weight: bold;
            color: var(--navy-blue);
            text-align: center;
            width: 80px;
        }
        
        .manager {
            min-width: 150px;
        }
        
        .manager strong {
            color: var(--navy-blue);
            font-size: 16px;
        }
        
        .wins, .losses {
            font-weight: bold;
            text-align: center;
            width: 80px;
        }
        
        .win-pct {
            text-align: center;
            width: 100px;
        }
        
        .total-games, .leagues, .active-leagues {
            text-align: center;
            width: 90px;
            font-weight: 500;
        }
        
        .manager-details-row {
            background-color: #f8f9fa !important;
        }
        
        .manager-details-content {
            border-radius: 8px;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: var(--navy-blue);
        }
        
        .stat-label {
            font-size: 12px;
            color: var(--silver-grey);
            text-transform: uppercase;
        }
        
        /* Mobile Responsive Design */
        @media (max-width: 768px) {
            .container-fluid {
                padding: 0 10px;
            }
            
            .comparison-header {
                padding: 15px 0;
            }
            
            .comparison-header h1 {
                font-size: 1.8em;
                margin-bottom: 10px;
            }
            
            .comparison-header p {
                font-size: 14px;
            }
            
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                margin: 0 -10px;
                padding: 0 10px;
            }
            
            .results-table {
                min-width: 600px;
                font-size: 13px;
            }
            
            .results-table th,
            .results-table td {
                padding: 8px 4px;
                white-space: nowrap;
            }
            
            .results-table .manager {
                min-width: 120px;
                max-width: 150px;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            .results-table .rank {
                width: 40px;
                text-align: center;
            }
            
            .btn-sm {
                padding: 6px 10px;
                font-size: 12px;
            }
        }
        
        @media (max-width: 480px) {
            .comparison-header h1 {
                font-size: 1.5em;
            }
            
            .results-table {
                font-size: 12px;
            }
            
            .results-table th,
            .results-table td {
                padding: 6px 3px;
            }
        }
    </style>
</head>
<body>
    <!-- Dark Mode Toggle -->
    <div class="dark-mode-toggle">
        <button onclick="toggleDarkMode()" id="darkModeBtn" title="Toggle dark/light mode">
        </button>
    </div>
    
    <div class="container-fluid">
        <!-- Header -->
        <div class="comparison-header">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h1>Manager Comparison</h1>
                        <p class="mb-0">Cumulative performance comparison across all leagues in {{ season }} season</p>
                    </div>
                    <div class="col-md-4 text-end">
                        <a href="{{ url_for('manager.manager_search') }}" class="btn btn-light">
                            ‚Üê Back to Search
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="container">
            <!-- Comparison Statistics -->
            {% if comparison_data.stats %}
            <div class="comparison-stats">
                <h4>Comparison Overview</h4>
                <div class="row">
                    <div class="col-md-3">
                        <div class="stat-item">
                            <div class="stat-value">{{ comparison_data.stats.managers_found }}</div>
                            <div class="stat-label">Managers Found</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-item">
                            <div class="stat-value">{{ comparison_data.stats.total_games }}</div>
                            <div class="stat-label">Total Games</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-item">
                            <div class="stat-value">{{ comparison_data.stats.total_wins }}</div>
                            <div class="stat-label">Combined Wins</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-item">
                            <div class="stat-value">{{ "%.1f"|format(comparison_data.stats.average_win_percentage * 100) }}%</div>
                            <div class="stat-label">Average Win %</div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Missing Managers Warning -->
            {% if comparison_data.comparison_info.missing_managers %}
            <div class="missing-managers">
                <h6><i class="fas fa-exclamation-triangle"></i> Missing Managers</h6>
                <p class="mb-0">Could not find data for: <strong>{{ ', '.join(comparison_data.comparison_info.missing_managers) }}</strong></p>
                <small>Please check the usernames and try again.</small>
            </div>
            {% endif %}

            <!-- Manager Rankings Leaderboard -->
            {% if comparison_data.managers %}
            <div class="results-section">
                <div class="results-header mb-4">
                    <h2>Manager Comparison Leaderboard ({{ season }} Season)</h2>
                    <p class="text-muted">Ranked by cumulative performance across all leagues</p>
                </div>
                
                <div class="table-container">
                    <table class="results-table table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Rank</th>
                                <th>Manager</th>
                                <th>Wins</th>
                                <th>Losses</th>
                                <th>Win %</th>
                                <th>Total Games</th>
                                <th>Leagues</th>
                                <th>Active Leagues</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for manager in comparison_data.managers %}
                            <tr class="{{ 'table-warning' if loop.index <= 3 else '' }}">
                                <td class="rank fw-bold">
                                    {% if manager.rank == 1 %}ü•á{% elif manager.rank == 2 %}ü•à{% elif manager.rank == 3 %}ü•â{% else %}{{ manager.rank }}{% endif %}
                                </td>
                                <td class="manager">
                                    <div>
                                        <strong>{{ manager.display_name }}</strong>
                                        <br>
                                        <small class="text-muted">@{{ manager.username }}</small>
                                    </div>
                                </td>
                                <td class="wins text-success fw-bold">{{ manager.total_wins }}</td>
                                <td class="losses text-danger fw-bold">{{ manager.total_losses }}</td>
                                <td class="win-pct">
                                    <span class="badge {% if manager.win_percentage >= 0.7 %}bg-success{% elif manager.win_percentage >= 0.6 %}bg-info{% elif manager.win_percentage >= 0.5 %}bg-warning{% else %}bg-danger{% endif %}">
                                        {{ "%.1f"|format(manager.win_percentage * 100) }}%
                                    </span>
                                </td>
                                <td class="total-games">{{ manager.total_games }}</td>
                                <td class="leagues">{{ manager.total_leagues }}</td>
                                <td class="active-leagues">{{ manager.active_leagues }}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" onclick="toggleManagerDetails('{{ manager.username }}')">
                                        <i class="fas fa-info-circle"></i> View
                                    </button>
                                </td>
                            </tr>
                            <!-- Expandable Details Row -->
                            <tr id="details-{{ manager.username }}" class="manager-details-row" style="display: none;">
                                <td colspan="9">
                                    <div class="manager-details-content p-3 bg-light">
                                        <h6>League Breakdown for {{ manager.display_name }}:</h6>
                                        <div class="table-responsive">
                                            <table class="table table-sm">
                                                <thead>
                                                    <tr>
                                                        <th>League</th>
                                                        <th>Record</th>
                                                        <th>Win %</th>
                                                        <th>Games</th>
                                                        <th>Status</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="leagues-tbody-{{ manager.username }}">
                                                    <tr>
                                                        <td colspan="5" class="text-center">
                                                            <button class="btn btn-sm btn-outline-primary" onclick="loadManagerDetails('{{ manager.username }}', '{{ season }}')">
                                                                Load League Details
                                                            </button>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% else %}
                <div class="alert alert-warning text-center">
                    <h4>No Comparison Data</h4>
                    <p>Could not find data for the requested managers. Please check usernames and try again.</p>
                    <a href="{{ url_for('manager.manager_search') }}" class="btn btn-primary">Try Again</a>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://kit.fontawesome.com/your-fontawesome-kit.js" crossorigin="anonymous"></script>
    
    <script>
        function toggleManagerDetails(username) {
            const detailsRow = document.getElementById(`details-${username}`);
            const button = event.target.closest('button');
            
            if (detailsRow.style.display === 'none' || detailsRow.style.display === '') {
                detailsRow.style.display = 'table-row';
                button.innerHTML = '<i class="fas fa-eye-slash"></i> Hide';
            } else {
                detailsRow.style.display = 'none';
                button.innerHTML = '<i class="fas fa-info-circle"></i> View';
            }
        }
        
        function loadManagerDetails(username, season) {
            const tbody = document.getElementById(`leagues-tbody-${username}`);
            
            // Show loading state
            tbody.innerHTML = '<tr><td colspan="5" class="text-center">Loading...</td></tr>';
            
            // Make AJAX call to get detailed league breakdown
            fetch(`/api/manager/${username}/details?season=${season}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.leagues) {
                        populateManagerDetails(username, data.leagues);
                    } else {
                        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Failed to load league details</td></tr>';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Error loading league details</td></tr>';
                });
        }
        
        function populateManagerDetails(username, leagues) {
            const tbody = document.getElementById(`leagues-tbody-${username}`);
            
            if (!leagues || leagues.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center">No league details available</td></tr>';
                return;
            }
            
            tbody.innerHTML = leagues.map(league => `
                <tr>
                    <td>
                        <a href="/league/${league.league_id}?season=${league.season || '2025'}" class="text-decoration-none">
                            ${league.league_name || 'Unknown League'}
                        </a>
                    </td>
                    <td>${league.wins}-${league.losses}</td>
                    <td>${(league.win_percentage * 100).toFixed(1)}%</td>
                    <td>${league.total_games}</td>
                    <td>
                        <span class="badge ${league.is_active ? 'bg-success' : 'bg-secondary'}">
                            ${league.is_active ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                </tr>
            `).join('');
        }
    </script>
</body>
</html>